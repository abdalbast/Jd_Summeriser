<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>JD Skill Summariser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Summarise a job description into top skills, experience, and more.">
  <meta name="theme-color" content="#1f2937">
  <meta property="og:title" content="JD Skill Summariser">
  <meta property="og:description" content="Summarise a job description into top skills, experience, and more.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://abdalbast.github.io/Jd_Summeriser/">
  <meta name="twitter:card" content="summary">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%93%9D%3C/text%3E%3C/svg%3E">
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Job Description → Top Skills</h1>
        <p class="text-sm text-slate-600 dark:text-slate-300">Paste a JD or provide a link and summarise the top emphasised skills.</p>
      </div>
      <button id="themeToggle" class="px-3 py-1.5 rounded border border-slate-300 dark:border-slate-600 text-sm hover:bg-slate-100 dark:hover:bg-slate-800 shadow-sm" aria-label="Toggle dark mode">🌙</button>
    </header>

    <textarea id="jdText" class="w-full h-64 p-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Paste the job description here..."></textarea>

    <div class="mt-4 flex items-center gap-2">
      <button id="analyseBtn" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm">Summarise</button>
      <button id="clearBtn" class="px-4 py-2 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700 shadow-sm">Clear</button>
      <span class="text-xs text-slate-500 ml-2">Enter/Cmd+Enter: Summarise · Esc: Clear</span>
    </div>

    <div class="mt-6">
      <label class="block text-sm font-medium mb-2">Or fetch from URL (CORS permitting)</label>
      <div class="flex gap-2 items-center flex-wrap">
        <input id="jdUrl" type="url" class="flex-1 p-2 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://example.com/job-posting" />
        <label class="flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
          <input id="useProxy" type="checkbox" class="rounded border-slate-300 dark:border-slate-600" checked /> Use CORS proxy
        </label>
        <button id="fetchBtn" class="px-4 py-2 rounded bg-slate-800 text-white hover:bg-black inline-flex items-center gap-2">
          <span>Fetch</span>
          <svg id="fetchSpinner" class="hidden animate-spin h-4 w-4 text-white" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
      </div>
      <p id="fetchStatus" class="text-xs mt-2"></p>
      <p class="text-xs text-slate-500 mt-2">Note: Some sites block cross-origin fetches. If it fails, please copy-paste instead.</p>
    </div>

    <div class="mt-4 grid md:grid-cols-2 gap-2 items-center">
      <div class="flex items-center gap-2">
        <label for="customTerms" class="text-sm text-slate-600 whitespace-nowrap dark:text-slate-300">Custom terms (comma-separated)</label>
        <input id="customTerms" type="text" class="flex-1 p-2 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="e.g. NLP, GenAI, ETL" />
      </div>
      <div class="flex items-center gap-2">
        <label for="fileInput" class="text-sm text-slate-600 whitespace-nowrap dark:text-slate-300">Upload file</label>
        <input id="fileInput" type="file" accept=".txt,.html,.htm" class="p-2 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" />
      </div>
    </div>

    <section class="mt-8">
      <h2 class="text-xl font-semibold mb-2">Top Skills</h2>
      <div id="results" class="grid md:grid-cols-2 gap-4"></div>
    </section>
  </div>

  <script>
    // ARIA live region for generic announcements
    const announcer = document.createElement('div');
    announcer.setAttribute('aria-live','polite');
    announcer.className = 'sr-only';
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(announcer));

    // Theme initialisation respecting system preference and stored setting
    (function initTheme() {
      try {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if ((stored === 'dark') || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      } catch (_) {}
    })();

    document.getElementById('themeToggle').addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch (_) {}
      document.getElementById('themeToggle').textContent = isDark ? '☀️' : '🌙';
      announcer.textContent = isDark ? 'Dark mode enabled' : 'Light mode enabled';
    });

    // Expanded taxonomy with synonyms mapped to canonical skills and categories
    const TAXONOMY = {
      "Programming": {
        "Python": ["python"],
        "R": [" r "," r-language"," rstudio"],
        "SQL": ["sql","t-sql","postgresql","mysql","sqlite","snowflake sql","bigquery sql"],
        "JavaScript": ["javascript","js","ecmascript"],
        "TypeScript": ["typescript","ts"],
        "Java": ["java"],
        "C#": ["c#","dotnet",".net"],
        "C++": ["c++","cpp"],
        "Go": ["golang"," go "],
        "Scala": ["scala"]
      },
      "Data & ML": {
        "Pandas": ["pandas"],
        "NumPy": ["numpy"],
        "scikit-learn": ["scikit-learn","sklearn"],
        "TensorFlow": ["tensorflow","tf"],
        "PyTorch": ["pytorch","torch"],
        "XGBoost": ["xgboost"],
        "LightGBM": ["lightgbm","lgbm"],
        "Tableau": ["tableau"],
        "Power BI": ["power bi","powerbi"],
        "Excel": ["excel","microsoft excel"],
        "Looker": ["looker","looker studio","data studio"],
        "dbt": ["dbt","data build tool"]
      },
      "Cloud & DevOps": {
        "AWS": ["aws","amazon web services"],
        "Azure": ["azure","microsoft azure"],
        "GCP": ["gcp","google cloud","google cloud platform"],
        "Docker": ["docker"],
        "Kubernetes": ["kubernetes","k8s"],
        "Linux": ["linux","ubuntu","red hat","rhel"],
        "Git": ["git","github","gitlab","bitbucket"],
        "Airflow": ["airflow","apache airflow"],
        "Kafka": ["kafka","apache kafka"],
        "Spark": ["spark","apache spark"]
      },
      "Methodologies": {
        "Agile": ["agile"],
        "Scrum": ["scrum"],
        "Kanban": ["kanban"],
        "CI/CD": ["ci/cd","continuous integration","continuous delivery","continuous deployment"],
        "TDD": ["tdd","test-driven development"]
      },
      "Soft Skills": {
        "Communication": ["communication","communicator","presenting","presentation"],
        "Teamwork": ["teamwork","collaboration","collaborative","cross-functional"],
        "Problem solving": ["problem solving","analytical","analytically"],
        "Leadership": ["leadership","mentor","coaching"],
        "Stakeholder management": ["stakeholder management","stakeholders"]
      },
      "Databases": {
        "PostgreSQL": ["postgresql","postgres"],
        "MySQL": ["mysql"],
        "SQL Server": ["sql server","mssql","t-sql"],
        "Snowflake": ["snowflake"],
        "BigQuery": ["bigquery"],
        "Redshift": ["redshift"]
      },
      "Certifications": {
        "AWS Certified": ["aws certified","solutions architect associate","solutions architect professional","developer associate","sysops"],
        "Azure Certified": ["azure certified","az-900","dp-900","dp-203"],
        "GCP Professional": ["google professional","professional data engineer","professional cloud architect"],
        "PMP": ["pmp","project management professional"],
        "PRINCE2": ["prince2"],
        "ITIL": ["itil"],
        "Scrum Master": ["scrum master","psm","csm"]
      },
      "Education": {
        "BSc/BA": ["bsc","bachelor's","bachelors","b.a.","ba"],
        "MSc/MA": ["msc","master's","masters","m.a.","ma"],
        "PhD": ["phd","doctorate","dphil"],
        "STEM degree": ["computer science","statistics","mathematics","engineering","data science"]
      },
      "Security": {
        "Security clearance": ["security clearance","sc clearance","dv clearance"],
        "ISO27001": ["iso 27001","iso27001"],
        "SOC 2": ["soc 2","soc2"]
      }
    };

    const el = id => document.getElementById(id);

    function normalise(text) {
      return text
        .toLowerCase()
        .replace(/\u2013|\u2014/g, '-')
        .replace(/[^a-z0-9+.#\/\-\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function htmlToText(html) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        doc.querySelectorAll('script,style').forEach(n => n.remove());
        const text = (doc.body && doc.body.textContent) ? doc.body.textContent : '';
        return text.replace(/\s+/g, ' ').trim();
      } catch (_) {
        return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
      }
    }

    function buildSkillCounts(text) {
      const countsByCategory = {};
      const flatTop = [];
      const corpus = ' ' + normalise(text) + ' ';
      Object.entries(TAXONOMY).forEach(([category, skills]) => {
        countsByCategory[category] = [];
        Object.entries(skills).forEach(([canonical, synonyms]) => {
          let count = 0;
          synonyms.forEach(term => {
            const escaped = term.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp('\\b' + escaped + '\\b', 'g');
            const matches = corpus.match(regex);
            if (matches) count += matches.length;
          });
          if (count > 0) {
            countsByCategory[category].push({ skill: canonical, count });
            flatTop.push({ skill: canonical, count, category });
          }
        });
        countsByCategory[category].sort((a,b) => b.count - a.count);
      });
      flatTop.sort((a,b) => b.count - a.count);
      return { countsByCategory, top10: flatTop.slice(0, 10) };
    }

    function extractMeta(text) {
      const t = normalise(text);
      const yearsMatches = [...t.matchAll(/(\d{1,2})\+?\s*(years|yrs|y)/g)];
      const years = yearsMatches.map(m => parseInt(m[1], 10)).filter(n => !Number.isNaN(n));
      const maxYears = years.length ? Math.max(...years) : null;

      const seniorityOrder = ['intern','junior','mid','senior','lead','principal','staff','manager','director','head'];
      const seniorityMap = {
        intern: /(intern|placement)/,
        junior: /(junior|entry[-\s]?level)/,
        mid: /(mid|intermediate)/,
        senior: /(senior|sr\b)/,
        lead: /(lead|leading|tech lead)/,
        principal: /(principal)/,
        staff: /(staff engineer)/,
        manager: /(manager|management)/,
        director: /(director|head of)/,
        head: /(head of)/
      };
      const seniorities = seniorityOrder.filter(key => seniorityMap[key].test(t));
      const seniority = seniorities.length ? seniorities[seniorities.length - 1] : null;

      const subjects = [];
      const subjectMatches = [...t.matchAll(/degree\s+in\s+([a-z\s]{3,40})/g)];
      subjectMatches.forEach(m => subjects.push(m[1].trim()));

      return { yearsExperience: maxYears, seniority, degreeSubjects: subjects };
    }

    function summariseJD(text, customTermsArray) {
      const { countsByCategory, top10 } = buildSkillCounts(text);
      const customCounts = {};
      if (customTermsArray && customTermsArray.length) {
        const t = ' ' + normalise(text) + ' ';
        customTermsArray.forEach(term => {
          const raw = term.trim();
          if (!raw) return;
          const escaped = raw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp('\\b' + escaped + '\\b', 'g');
          const matches = t.match(regex);
          if (matches) customCounts[raw] = matches.length;
        });
      }
      const meta = extractMeta(text);
      return { countsByCategory, top10, customCounts, meta };
    }

    function toCsv(results) {
      const rows = [['rank','skill','count','category']];
      (results.top10 || []).forEach((item, idx) => {
        rows.push([String(idx+1), item.skill, String(item.count), item.category || '']);
      });
      return rows.map(r => r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',')).join('\n');
    }

    function renderResults(results) {
      const container = el("results");
      container.innerHTML = "";
      if (!results || (!results.top10.length && Object.keys(results.customCounts||{}).length === 0)) {
        container.innerHTML = "<p class='text-slate-600'>No skills detected.</p>";
        return;
      }

      const meta = results.meta || {};
      const metaDiv = document.createElement('div');
      metaDiv.className = "p-4 bg-white rounded-lg border dark:bg-slate-800 dark:border-slate-700 shadow-sm";
      metaDiv.innerHTML = `
        <h3 class="font-semibold mb-2">Summary</h3>
        <div class="text-sm text-slate-600 dark:text-slate-300 space-y-1">
          <div><span class="font-medium">Seniority:</span> ${meta.seniority ? meta.seniority : 'Not stated'}</div>
          <div><span class="font-medium">Years of experience:</span> ${meta.yearsExperience != null ? meta.yearsExperience : 'Not stated'}</div>
          ${meta.degreeSubjects && meta.degreeSubjects.length ? `<div><span class="font-medium">Degree subjects:</span> ${meta.degreeSubjects.join(', ')}</div>` : ''}
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="copyBtn" class="px-3 py-1.5 rounded bg-slate-800 text-white text-sm hover:bg-black">Copy JSON</button>
          <button id="exportBtn" class="px-3 py-1.5 rounded bg-slate-200 text-sm hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Export JSON</button>
          <button id="exportCsvBtn" class="px-3 py-1.5 rounded bg-slate-200 text-sm hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Export CSV</button>
          <button id="copyListBtn" class="px-3 py-1.5 rounded bg-slate-200 text-sm hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Copy skills (comma)</button>
        </div>
      `;
      container.appendChild(metaDiv);

      if (results.top10.length) {
        const topDiv = document.createElement('div');
        topDiv.className = "p-4 bg-white rounded-lg border dark:bg-slate-800 dark:border-slate-700 shadow-sm";
        topDiv.innerHTML = `<h3 class=\"font-semibold mb-2\">Top Skills</h3>`;
        const list = document.createElement('div');
        list.className = "flex flex-wrap gap-2";
        results.top10.forEach((item, idx) => {
          const chip = document.createElement('span');
          chip.className = "inline-flex items-center gap-1 px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200 text-sm dark:bg-indigo-200/20 dark:text-indigo-200 dark:border-indigo-300/30";
          chip.textContent = `${idx+1}. ${item.skill} (${item.count})`;
          list.appendChild(chip);
        });
        topDiv.appendChild(list);
        container.appendChild(topDiv);
      }

      Object.entries(results.countsByCategory).forEach(([category, items]) => {
        if (!items.length) return;
        const div = document.createElement('div');
        div.className = "p-4 bg-white rounded-lg border dark:bg-slate-800 dark:border-slate-700 shadow-sm";
        div.innerHTML = `<h3 class=\"font-semibold mb-2\">${category}</h3>`;
        const list = document.createElement('div');
        list.className = "flex flex-wrap gap-2";
        items.forEach(({skill, count}) => {
          const chip = document.createElement('span');
          chip.className = "inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-slate-700 border text-sm dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600";
          chip.textContent = `${skill} (${count})`;
          list.appendChild(chip);
        });
        div.appendChild(list);
        container.appendChild(div);
      });

      const payload = JSON.stringify(results, null, 2);
      const copyBtn = document.getElementById('copyBtn');
      if (copyBtn) copyBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(payload); copyBtn.textContent = 'Copied'; setTimeout(() => copyBtn.textContent = 'Copy JSON', 1200); } catch {}
      };
      const exportBtn = document.getElementById('exportBtn');
      if (exportBtn) exportBtn.onclick = () => {
        const blob = new Blob([payload], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'jd-summary.json'; a.click();
        URL.revokeObjectURL(url);
      };
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      if (exportCsvBtn) exportCsvBtn.onclick = () => {
        const csv = toCsv(results);
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'jd-top-skills.csv'; a.click();
        URL.revokeObjectURL(url);
      };
      const copyListBtn = document.getElementById('copyListBtn');
      if (copyListBtn) copyListBtn.onclick = async () => {
        const list = (results.top10 || []).map(i => i.skill).join(', ');
        try { await navigator.clipboard.writeText(list); copyListBtn.textContent = 'Copied'; setTimeout(() => copyListBtn.textContent = 'Copy skills (comma)', 1200); } catch {}
      };
    }

    function getCustomTerms() {
      const customEl = el('customTerms');
      const raw = ((customEl && customEl.value) || '').split(',');
      return raw.map(s => s.trim()).filter(Boolean);
    }

    async function runAnalysis() {
      const jd = el("jdText").value;
      const results = summariseJD(jd, getCustomTerms());
      renderResults(results);
    }

    el("analyseBtn").addEventListener("click", runAnalysis);

    // Keyboard shortcuts: Enter/Cmd+Enter summarise; Esc clear
    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().includes('MAC');
      if ((e.key === 'Enter' && (isMac ? e.metaKey : e.ctrlKey)) || (e.key === 'Enter' && e.target.id === 'jdText')) {
        e.preventDefault();
        runAnalysis();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        el('jdText').value = '';
        renderResults({ top10: [], countsByCategory: {}, customCounts: {}, meta: {} });
      }
    });

    el("clearBtn").addEventListener("click", () => {
      el("jdText").value = "";
      renderResults({ top10: [], countsByCategory: {}, customCounts: {}, meta: {} });
    });

    function buildProxyUrls(raw) {
      // Returns an array of proxy URLs to try
      try {
        const u = new URL(raw);
        const proto = (u.protocol || 'https:').replace(':',''); // 'http' | 'https'
        const path = u.pathname + (u.search || "") + (u.hash || "");
        const base = u.host + path;
        const urls = [
          `https://r.jina.ai/${proto}://${base}`,
          // Try the alternate protocol as well
          `https://r.jina.ai/${proto === 'https' ? 'http' : 'https'}://${base}`
        ];
        return urls;
      } catch (_) { return []; }
    }

    function setFetchStatus(message, kind) {
      const s = document.getElementById('fetchStatus');
      if (!s) return;
      const base = 'text-xs';
      const classes = {
        info: 'text-slate-600 dark:text-slate-300',
        success: 'text-emerald-700 dark:text-emerald-400',
        warn: 'text-amber-700 dark:text-amber-400',
        error: 'text-rose-700 dark:text-rose-400'
      };
      s.className = base + ' ' + (classes[kind] || classes.info);
      s.textContent = message || '';
    }

    el("fetchBtn").addEventListener("click", async () => {
      const raw = el("jdUrl").value.trim();
      if (!raw) return;
      // Default to proxy unless explicitly unticked
      const wantProxy = (document.getElementById('useProxy')?.checked !== false);
      let tryUrls = [];
      if (wantProxy) {
        tryUrls = tryUrls.concat(buildProxyUrls(raw));
      }
      tryUrls.push(raw); // always try direct as well (or vice versa)

      el("fetchBtn").disabled = true;
      el("fetchBtn").textContent = "Fetching…";
      el("fetchBtn").setAttribute('aria-busy','true');
      setFetchStatus('Fetching job description…', 'info');
      const spinner = document.getElementById('fetchSpinner');
      if (spinner) spinner.classList.remove('hidden');
      let lastErr = null;
      for (const u of tryUrls) {
        try {
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), 12000);
          const res = await fetch(u, {mode: "cors", signal: controller.signal});
          clearTimeout(timer);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const html = await res.text();
          const text = htmlToText(html);
          el("jdText").value = text;
          lastErr = null;
          setFetchStatus('Loaded successfully. Analysing…', 'info');
          // Auto-run summarisation after successful fetch
          await Promise.resolve().then(runAnalysis);
          break;
        } catch (e) {
          lastErr = e;
          // Keep trying next URL
        }
      }
      if (lastErr) {
        const msg = (lastErr.name === 'AbortError') ? 'Timed out fetching the page.' : (lastErr && lastErr.message ? lastErr.message : 'Unknown error');
        setFetchStatus(`Fetch failed (likely CORS or blocked). ${msg}. Try enabling the proxy or copy-paste instead.`, 'error');
      }
      el("fetchBtn").disabled = false;
      el("fetchBtn").textContent = "Fetch";
      el("fetchBtn").removeAttribute('aria-busy');
      if (spinner) spinner.classList.add('hidden');
    });

    // File upload support (.txt / .html)
    document.addEventListener('change', async (e) => {
      const target = e.target;
      if (target && target.id === 'fileInput' && target.files && target.files[0]) {
        const file = target.files[0];
        const text = await file.text();
        const plain = file.type.includes('html') ? htmlToText(text) : text;
        el('jdText').value = plain;
      }
    });
  </script>
</body>
</html>
