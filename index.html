<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>JD Skill Summariser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="description" content="Summarise a job description into top skills, experience, and more.">
  <meta name="theme-color" content="#1f2937">
  <meta property="og:title" content="JD Skill Summariser">
  <meta property="og:description" content="Summarise a job description into top skills, experience, and more.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://abdalbast.github.io/Jd_Summeriser/">
  <meta name="twitter:card" content="summary">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%93%9D%3C/text%3E%3C/svg%3E">
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PDF.js for basic client-side PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- Mammoth.js for client-side .docx to text -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <!-- Docx templating and generation (browser) -->
  <script src="https://unpkg.com/pizzip@3.1.7/dist/pizzip.min.js"></script>
  <script src="https://unpkg.com/docxtemplater@3.44.0/build/docxtemplater.js"></script>
  <script src="https://unpkg.com/docx@8.3.2/build/index.js"></script>
  <script type="module" src="./src/main.js"></script>
  <style>
    :root { --ring: 2px; --radius: 10px; --elev: 0 1px 2px rgba(0,0,0,.06); --dur: 160ms; }
    @media (prefers-reduced-motion: reduce) { * { animation-duration: 1ms !important; transition-duration: 1ms !important; } }
    .card { border-radius: var(--radius); box-shadow: var(--elev); }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 var(--ring) rgba(99,102,241,.5); }
  </style>
  <script>window.PROXY_URL = "https://jd-summeriser-fhkbspbaw-abdalbast-khdhirs-projects.vercel.app/";</script>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <header class="max-w-6xl mx-auto p-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Job Description → Top Skills</h1>
        <p class="text-sm text-slate-600 dark:text-slate-300">Paste a JD or provide a link. Optionally upload a CV to see JD ↔ CV match.</p>
      </div>
      <button id="themeToggle" class="px-3 py-1.5 rounded border border-slate-300 dark:border-slate-600 text-sm hover:bg-slate-100 dark:hover:bg-slate-800 shadow-sm" aria-label="Toggle dark mode">🌙</button>
    </div>
    </header>
  <main class="max-w-6xl mx-auto p-6" role="main">

    <label for="jdText" class="block text-sm font-medium mb-1">Job description</label>
    <div class="relative">
      <textarea id="jdText" class="w-full h-64 max-h-[60vh] p-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm focus-ring overflow-auto" placeholder="Paste the job description here..." aria-describedby="jdHelp"></textarea>
      <div id="jdChar" class="absolute bottom-2 right-3 text-xs text-slate-500">0 chars</div>
    </div>
    <p id="jdHelp" class="mt-1 text-xs text-slate-500">Large posts will scroll inside the box. Press Enter/Cmd+Enter to summarise.</p>

    <div class="sticky top-0 z-10 -mx-6 px-6 py-3 bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur supports-[backdrop-filter]:backdrop-blur border-b border-slate-200/60 dark:border-slate-700/60 mt-4">
      <div class="flex flex-wrap items-center gap-2">
        <button id="analyseBtn" class="h-11 px-4 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed shadow-sm">Summarise</button>
        <button id="clearBtn" class="h-11 px-4 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700 shadow-sm">Clear</button>
        <div class="ml-auto flex items-center gap-2">
          <button id="fetchBtn" class="h-11 px-4 rounded bg-slate-800 text-white hover:bg-black inline-flex items-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed">
            <span>Fetch</span>
            <svg id="fetchSpinner" class="hidden animate-spin h-4 w-4 text-white" viewBox="0 0 24 24" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
          </button>
        </div>
      </div>
      <p class="mt-1 text-xs text-slate-500">Enter/Cmd+Enter: Summarise · Esc: Clear</p>
    </div>

    <div class="mt-6" aria-labelledby="fetchLabel">
      <label id="fetchLabel" class="block text-sm font-medium mb-2">Or fetch from URL</label>
      <div class="flex gap-2 items-center flex-wrap">
        <input id="jdUrl" type="url" class="flex-1 h-11 px-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm focus-ring" placeholder="https://example.com/job-posting" inputmode="url" aria-describedby="fetchHelp" />
        <label class="flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300" title="Read-only proxy that bypasses many CORS blocks.">
          <input id="useProxy" type="checkbox" class="rounded border-slate-300 dark:border-slate-600" checked /> Use CORS proxy
        </label>
      </div>
      <p id="fetchStatus" class="text-xs mt-2" aria-live="polite"></p>
      <p id="fetchHelp" class="text-xs text-slate-500 mt-2">This site may block cross-origin requests. Try copy-paste or leave the CORS proxy on.</p>
    </div>

    <div class="mt-4 grid md:grid-cols-2 gap-2 items-center" aria-label="Options">
      <div class="flex items-center gap-2">
        <label for="customTerms" class="text-sm text-slate-600 whitespace-nowrap dark:text-slate-300">Custom terms (comma-separated)</label>
        <input id="customTerms" type="text" class="flex-1 h-11 px-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus-ring" placeholder="e.g. NLP, GenAI, ETL" />
      </div>
      <div class="flex items-center gap-2">
        <label for="fileInput" class="text-sm text-slate-600 whitespace-nowrap dark:text-slate-300">Upload file</label>
        <input id="fileInput" type="file" accept=".txt,.html,.htm" class="h-11 px-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus-ring" />
      </div>
    </div>

    <section class="mt-6" aria-labelledby="cvLabel">
      <h2 id="cvLabel" class="text-xl font-semibold mb-2">Your CV/Resume (optional for match)</h2>
      <div class="grid md:grid-cols-2 gap-2 items-start">
        <textarea id="cvText" class="w-full h-40 max-h-[40vh] p-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm focus-ring overflow-auto" placeholder="Paste your CV here (text only)"></textarea>
        <div class="flex items-center gap-2">
          <label for="cvFile" class="text-sm text-slate-600 whitespace-nowrap dark:text-slate-300">Upload CV (.pdf / .docx / .txt)</label>
          <input id="cvFile" type="file" accept=".pdf,.docx,.txt,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="h-11 px-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus-ring" />
          <button id="cvMatchBtn" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm">Match JD ↔ CV</button>
        </div>
      </div>
    </section>

    <section class="mt-8" aria-labelledby="resultsLabel">
      <h2 id="resultsLabel" class="text-xl font-semibold mb-2">Top Skills</h2>
      <div id="resultsEmpty" class="hidden card p-6 bg-white dark:bg-slate-800 border dark:border-slate-700 text-slate-600 dark:text-slate-300">
        <p class="font-medium">Ready to summarise</p>
        <p class="text-sm mt-1">Paste a job description, fetch a URL, or upload a file to begin.</p>
      </div>
      <div id="resultsSkeleton" class="hidden grid md:grid-cols-2 gap-4">
        <div class="card p-4 bg-white dark:bg-slate-800 border dark:border-slate-700 animate-pulse h-28"></div>
        <div class="card p-4 bg-white dark:bg-slate-800 border dark:border-slate-700 animate-pulse h-28"></div>
      </div>
      <div id="results" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <!-- BEGIN UI PASS: Tailor CV panel -->
    <section class="mt-8" aria-labelledby="tailorLabel">
      <h2 id="tailorLabel" class="text-xl font-semibold mb-2">Tailor CV</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card p-4 bg-white dark:bg-slate-800 border dark:border-slate-700">
          <fieldset class="mb-3">
            <legend class="text-sm font-medium">Job Source</legend>
            <div class="mt-2 flex items-center gap-4 text-sm">
              <label class="inline-flex items-center gap-2"><input type="radio" name="jobSrc" value="paste" checked> Paste Text</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="jobSrc" value="url"> URL</label>
            </div>
          </fieldset>
          <div id="tailorPaste">
            <label class="block text-sm font-medium mb-1" for="tailorJdText">Paste Job Description</label>
            <textarea id="tailorJdText" class="w-full h-40 p-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus-ring"></textarea>
          </div>
          <div id="tailorUrl" class="hidden">
            <label class="block text-sm font-medium mb-1" for="tailorJdUrl">Job URL</label>
            <input id="tailorJdUrl" type="url" class="w-full h-11 px-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus-ring" placeholder="https://example.com/post" />
          </div>
          <label class="block text-sm font-medium mt-3 mb-1" for="targetSkills">Target Skills</label>
          <input id="targetSkills" type="text" class="w-full h-11 px-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus-ring" value="Snowflake, Scala, Problem solving, Leadership" />
          <label class="block text-sm font-medium mt-3 mb-1" for="templateDocx">Upload Original CV (.docx template, optional)</label>
          <input id="templateDocx" type="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="w-full h-11 px-3 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus-ring" />
          <div class="mt-4 flex gap-2">
            <button id="genSuggBtn" class="h-11 px-4 rounded bg-indigo-600 text-white hover:bg-indigo-700">Generate Suggestions</button>
            <button id="downloadDocxBtn" class="h-11 px-4 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100">Download Tailored CV (.docx)</button>
          </div>
          <p id="tailorStatus" class="text-xs mt-2"></p>
        </div>
        <div class="card p-4 bg-white dark:bg-slate-800 border dark:border-slate-700">
          <div class="flex items-center gap-4 text-sm border-b dark:border-slate-700 mb-3" role="tablist" aria-label="Tailor CV results">
            <button id="tabSugg" role="tab" aria-selected="true" tabindex="0" class="py-2 px-2 border-b-2 border-indigo-600">Suggestions</button>
            <button id="tabDiff" role="tab" aria-selected="false" tabindex="-1" class="py-2 px-2">Diff Preview</button>
            <div class="ml-auto flex items-center gap-2">
              <button id="copySuggJson" class="h-8 px-2 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 text-xs">Copy JSON</button>
              <button id="copyLLM" class="h-8 px-2 rounded bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 text-xs">Copy LLM text</button>
            </div>
          </div>
          <div id="suggPane" role="tabpanel" aria-labelledby="tabSugg" class="space-y-3 text-sm"></div>
          <div id="diffPane" role="tabpanel" aria-labelledby="tabDiff" class="hidden space-y-3 text-sm"></div>
        </div>
  </div>
    </section>
    <!-- END UI PASS -->
  </main>
  <footer class="max-w-6xl mx-auto px-6 py-8 text-xs text-slate-500">Built with HTML, Tailwind, and vanilla JS. All analysis runs in your browser.</footer>
  <button id="backToTop" aria-label="Back to top" class="hidden fixed bottom-5 right-5 h-11 w-11 rounded-full bg-slate-800 text-white dark:bg-slate-700 shadow-sm hover:bg-black focus-ring">↑</button>

  <script>
    // ARIA live region for generic announcements
    const announcer = document.createElement('div');
    announcer.setAttribute('aria-live','polite');
    announcer.className = 'sr-only';
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(announcer));

    // Theme initialisation respecting system preference and stored setting
    (function initTheme() {
      try {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if ((stored === 'dark') || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      } catch (_) {}
    })();

    document.getElementById('themeToggle').addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch (_) {}
      document.getElementById('themeToggle').textContent = isDark ? '☀️' : '🌙';
      announcer.textContent = isDark ? 'Dark mode enabled' : 'Light mode enabled';
    });

    // Expanded taxonomy with synonyms mapped to canonical skills and categories
    const TAXONOMY = {
      "Programming": {
        "Python": ["python"],
        "R": [" r "," r-language"," rstudio"],
        "SQL": ["sql","t-sql","postgresql","mysql","sqlite","snowflake sql","bigquery sql"],
        "JavaScript": ["javascript","js","ecmascript"],
        "TypeScript": ["typescript","ts"],
        "Java": ["java"],
        "C#": ["c#","dotnet",".net"],
        "C++": ["c++","cpp"],
        "Go": ["golang"," go "],
        "Scala": ["scala"]
      },
      "Data & ML": {
        "Pandas": ["pandas"],
        "NumPy": ["numpy"],
        "scikit-learn": ["scikit-learn","sklearn"],
        "TensorFlow": ["tensorflow","tf"],
        "PyTorch": ["pytorch","torch"],
        "XGBoost": ["xgboost"],
        "LightGBM": ["lightgbm","lgbm"],
        "Tableau": ["tableau"],
        "Power BI": ["power bi","powerbi"],
        "Excel": ["excel","microsoft excel"],
        "Looker": ["looker","looker studio","data studio"],
        "dbt": ["dbt","data build tool"]
      },
      "Cloud & DevOps": {
        "AWS": ["aws","amazon web services"],
        "Azure": ["azure","microsoft azure"],
        "GCP": ["gcp","google cloud","google cloud platform"],
        "Docker": ["docker"],
        "Kubernetes": ["kubernetes","k8s"],
        "Linux": ["linux","ubuntu","red hat","rhel"],
        "Git": ["git","github","gitlab","bitbucket"],
        "Airflow": ["airflow","apache airflow"],
        "Kafka": ["kafka","apache kafka"],
        "Spark": ["spark","apache spark"]
      },
      "Methodologies": {
        "Agile": ["agile"],
        "Scrum": ["scrum"],
        "Kanban": ["kanban"],
        "CI/CD": ["ci/cd","continuous integration","continuous delivery","continuous deployment"],
        "TDD": ["tdd","test-driven development"]
      },
      "Soft Skills": {
        "Communication": ["communication","communicator","presenting","presentation"],
        "Teamwork": ["teamwork","collaboration","collaborative","cross-functional"],
        "Problem solving": ["problem solving","analytical","analytically"],
        "Leadership": ["leadership","mentor","coaching"],
        "Stakeholder management": ["stakeholder management","stakeholders"]
      },
      "Databases": {
        "PostgreSQL": ["postgresql","postgres"],
        "MySQL": ["mysql"],
        "SQL Server": ["sql server","mssql","t-sql"],
        "Snowflake": ["snowflake"],
        "BigQuery": ["bigquery"],
        "Redshift": ["redshift"]
      },
      "Certifications": {
        "AWS Certified": ["aws certified","solutions architect associate","solutions architect professional","developer associate","sysops"],
        "Azure Certified": ["azure certified","az-900","dp-900","dp-203"],
        "GCP Professional": ["google professional","professional data engineer","professional cloud architect"],
        "PMP": ["pmp","project management professional"],
        "PRINCE2": ["prince2"],
        "ITIL": ["itil"],
        "Scrum Master": ["scrum master","psm","csm"]
      },
      "Education": {
        "BSc/BA": ["bsc","bachelor's","bachelors","b.a.","ba"],
        "MSc/MA": ["msc","master's","masters","m.a.","ma"],
        "PhD": ["phd","doctorate","dphil"],
        "STEM degree": ["computer science","statistics","mathematics","engineering","data science"]
      },
      "Security": {
        "Security clearance": ["security clearance","sc clearance","dv clearance"],
        "ISO27001": ["iso 27001","iso27001"],
        "SOC 2": ["soc 2","soc2"]
      }
    };

    const el = id => document.getElementById(id);

    function normalise(text) {
      return text
        .toLowerCase()
        .replace(/\u2013|\u2014/g, '-')
        .replace(/[^a-z0-9+.#\/\-\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function htmlToText(html) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        doc.querySelectorAll('script,style').forEach(n => n.remove());
        const text = (doc.body && doc.body.textContent) ? doc.body.textContent : '';
        return text.replace(/\s+/g, ' ').trim();
      } catch (_) {
        return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
      }
    }

    function buildSkillCounts(text) {
      const countsByCategory = {};
      const flatTop = [];
      const corpus = ' ' + normalise(text) + ' ';
      Object.entries(TAXONOMY).forEach(([category, skills]) => {
        countsByCategory[category] = [];
        Object.entries(skills).forEach(([canonical, synonyms]) => {
          let count = 0;
          synonyms.forEach(term => {
            const escaped = term.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp('\\b' + escaped + '\\b', 'g');
            const matches = corpus.match(regex);
            if (matches) count += matches.length;
          });
          if (count > 0) {
            countsByCategory[category].push({ skill: canonical, count });
            flatTop.push({ skill: canonical, count, category });
          }
        });
        countsByCategory[category].sort((a,b) => b.count - a.count);
      });
      flatTop.sort((a,b) => b.count - a.count);
      return { countsByCategory, top10: flatTop.slice(0, 10) };
    }

    function extractMeta(text) {
      const t = normalise(text);
      const yearsMatches = [...t.matchAll(/(\d{1,2})\+?\s*(years|yrs|y)/g)];
      const years = yearsMatches.map(m => parseInt(m[1], 10)).filter(n => !Number.isNaN(n));
      const maxYears = years.length ? Math.max(...years) : null;

      const seniorityOrder = ['intern','junior','mid','senior','lead','principal','staff','manager','director','head'];
      const seniorityMap = {
        intern: /(intern|placement)/,
        junior: /(junior|entry[-\s]?level)/,
        mid: /(mid|intermediate)/,
        senior: /(senior|sr\b)/,
        lead: /(lead|leading|tech lead)/,
        principal: /(principal)/,
        staff: /(staff engineer)/,
        manager: /(manager|management)/,
        director: /(director|head of)/,
        head: /(head of)/
      };
      const seniorities = seniorityOrder.filter(key => seniorityMap[key].test(t));
      const seniority = seniorities.length ? seniorities[seniorities.length - 1] : null;

      const subjects = [];
      const subjectMatches = [...t.matchAll(/degree\s+in\s+([a-z\s]{3,40})/g)];
      subjectMatches.forEach(m => subjects.push(m[1].trim()));

      return { yearsExperience: maxYears, seniority, degreeSubjects: subjects };
    }

    function summariseJD(text, customTermsArray) {
      const { countsByCategory, top10 } = buildSkillCounts(text);
      const customCounts = {};
      if (customTermsArray && customTermsArray.length) {
        const t = ' ' + normalise(text) + ' ';
        customTermsArray.forEach(term => {
          const raw = term.trim();
          if (!raw) return;
          const escaped = raw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp('\\b' + escaped + '\\b', 'g');
          const matches = t.match(regex);
          if (matches) customCounts[raw] = matches.length;
        });
      }
      const meta = extractMeta(text);
      return { countsByCategory, top10, customCounts, meta };
    }

    function toCsv(results) {
      const rows = [['rank','skill','count','category']];
      (results.top10 || []).forEach((item, idx) => {
        rows.push([String(idx+1), item.skill, String(item.count), item.category || '']);
      });
      return rows.map(r => r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',')).join('\n');
    }

    function buildSkillPresence(text) {
      const t = ' ' + normalise(text) + ' ';
      const present = new Set();
      Object.entries(TAXONOMY).forEach(([, skills]) => {
        Object.entries(skills).forEach(([canonical, synonyms]) => {
          for (const term of synonyms) {
            const escaped = term.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp('\\b' + escaped + '\\b', 'g');
            if (t.match(regex)) { present.add(canonical); break; }
          }
        });
      });
      return present;
    }

    function renderResults(results) {
      const container = el("results");
      container.innerHTML = "";
      if (!results || (!results.top10.length && Object.keys(results.customCounts||{}).length === 0)) {
        container.innerHTML = "<p class='text-slate-600'>No skills detected.</p>";
        return;
      }

      // CV Match (if CV provided)
      const cvTextVal = (el('cvText') && el('cvText').value || '').trim();
      if (cvTextVal) {
        const matchDiv = document.createElement('div');
        matchDiv.className = "p-4 bg-white rounded-lg border dark:bg-slate-800 dark:border-slate-700 shadow-sm md:col-span-2";

        const cvPresence = buildSkillPresence(cvTextVal);
        const weights = {};
        let total = 0;
        (results.top10 || []).forEach(item => { total += item.count; });
        (results.top10 || []).forEach(item => { weights[item.skill] = total ? item.count/total : 0; });

        const matched = [];
        const missing = [];
        let score = 0;
        (results.top10 || []).forEach(item => {
          if (cvPresence.has(item.skill)) { matched.push(item.skill); score += weights[item.skill]; }
          else missing.push(item.skill);
        });

        const jdMeta = results.meta || {};
        const cvMeta = extractMeta(cvTextVal);
        if (jdMeta.yearsExperience != null && cvMeta.yearsExperience != null && cvMeta.yearsExperience >= jdMeta.yearsExperience) score += 0.05;
        if (jdMeta.seniority && cvMeta.seniority && jdMeta.seniority === cvMeta.seniority) score += 0.05;
        const certs = TAXONOMY['Certifications'] || {};
        let certBonus = 0;
        Object.keys(certs).forEach(c => { if (cvPresence.has(c)) certBonus += 0.03; });
        score += Math.min(certBonus, 0.12);
        if (score > 1) score = 1;
        const pct = Math.round(score * 100);

        matchDiv.innerHTML = `
          <h3 class="font-semibold mb-2">CV Match</h3>
          <div class="flex items-center gap-3">
            <div class="w-full">
              <div class="w-full h-3 bg-slate-200 dark:bg-slate-700 rounded overflow-hidden">
                <div class="h-full bg-emerald-600" style="width:${pct}%"></div>
              </div>
            </div>
            <div class="text-lg font-bold tabular-nums">${pct}%</div>
          </div>
          <div class="mt-3 grid md:grid-cols-2 gap-3 text-sm">
            <div>
              <div class="font-medium">Matched skills</div>
              <div class="mt-1 flex flex-wrap gap-2">${matched.map(s => `<span class=\"px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200 dark:bg-emerald-200/20 dark:text-emerald-200 dark:border-emerald-300/30\">${s}</span>`).join(' ') || '<span class=\"text-slate-500\">None</span>'}</div>
            </div>
            <div>
              <div class="font-medium">Gaps vs JD top skills</div>
              <div class="mt-1 flex flex-wrap gap-2">${missing.map(s => `<span class=\"px-2 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-200 dark:bg-rose-200/20 dark:text-rose-200 dark:border-rose-300/30\">${s}</span>`).join(' ') || '<span class=\"text-slate-500\">None</span>'}</div>
            </div>
          </div>
        `;
        container.appendChild(matchDiv);
      }

      const meta = results.meta || {};
      const metaDiv = document.createElement('div');
      metaDiv.className = "p-4 bg-white rounded-lg border dark:bg-slate-800 dark:border-slate-700 shadow-sm";
      metaDiv.innerHTML = `
        <h3 class="font-semibold mb-2">Summary</h3>
        <div class="text-sm text-slate-600 dark:text-slate-300 space-y-1">
          <div><span class="font-medium">Seniority:</span> ${meta.seniority ? meta.seniority : 'Not stated'}</div>
          <div><span class="font-medium">Years of experience:</span> ${meta.yearsExperience != null ? meta.yearsExperience : 'Not stated'}</div>
          ${meta.degreeSubjects && meta.degreeSubjects.length ? `<div><span class="font-medium">Degree subjects:</span> ${meta.degreeSubjects.join(', ')}</div>` : ''}
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="copyBtn" class="px-3 py-1.5 rounded bg-slate-800 text-white text-sm hover:bg-black">Copy JSON</button>
          <button id="exportBtn" class="px-3 py-1.5 rounded bg-slate-200 text-sm hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Export JSON</button>
          <button id="exportCsvBtn" class="px-3 py-1.5 rounded bg-slate-200 text-sm hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Export CSV</button>
          <button id="copyListBtn" class="px-3 py-1.5 rounded bg-slate-200 text-sm hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">Copy skills (comma)</button>
        </div>
      `;
      container.appendChild(metaDiv);

      if (results.top10.length) {
        const topDiv = document.createElement('div');
        topDiv.className = "p-4 bg-white rounded-lg border dark:bg-slate-800 dark:border-slate-700 shadow-sm";
        topDiv.innerHTML = `<h3 class=\"font-semibold mb-2\">Top Skills</h3>`;
        const list = document.createElement('div');
        list.className = "flex flex-wrap gap-2";
        results.top10.forEach((item, idx) => {
          const chip = document.createElement('span');
          chip.className = "inline-flex items-center gap-1 px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200 text-sm dark:bg-indigo-200/20 dark:text-indigo-200 dark:border-indigo-300/30";
          chip.textContent = `${idx+1}. ${item.skill} (${item.count})`;
          list.appendChild(chip);
        });
        topDiv.appendChild(list);
        container.appendChild(topDiv);
      }

      Object.entries(results.countsByCategory).forEach(([category, items]) => {
        if (!items.length) return;
        const div = document.createElement('div');
        div.className = "p-4 bg-white rounded-lg border dark:bg-slate-800 dark:border-slate-700 shadow-sm";
        div.innerHTML = `<h3 class=\"font-semibold mb-2\">${category}</h3>`;
        const list = document.createElement('div');
        list.className = "flex flex-wrap gap-2";
        items.forEach(({skill, count}) => {
          const chip = document.createElement('span');
          chip.className = "inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-slate-700 border text-sm dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600";
          chip.textContent = `${skill} (${count})`;
          list.appendChild(chip);
        });
        div.appendChild(list);
        container.appendChild(div);
      });

      const payload = JSON.stringify(results, null, 2);
      const copyBtn = document.getElementById('copyBtn');
      if (copyBtn) copyBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(payload); copyBtn.textContent = 'Copied'; setTimeout(() => copyBtn.textContent = 'Copy JSON', 1200); } catch {}
      };
      const exportBtn = document.getElementById('exportBtn');
      if (exportBtn) exportBtn.onclick = () => {
        const blob = new Blob([payload], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'jd-summary.json'; a.click();
        URL.revokeObjectURL(url);
      };
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      if (exportCsvBtn) exportCsvBtn.onclick = () => {
        const csv = toCsv(results);
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'jd-top-skills.csv'; a.click();
        URL.revokeObjectURL(url);
      };
      const copyListBtn = document.getElementById('copyListBtn');
      if (copyListBtn) copyListBtn.onclick = async () => {
        const list = (results.top10 || []).map(i => i.skill).join(', ');
        try { await navigator.clipboard.writeText(list); copyListBtn.textContent = 'Copied'; setTimeout(() => copyListBtn.textContent = 'Copy skills (comma)', 1200); } catch {}
      };
    }

    function getCustomTerms() {
      const customEl = el('customTerms');
      const raw = ((customEl && customEl.value) || '').split(',');
      return raw.map(s => s.trim()).filter(Boolean);
    }

    async function runAnalysis() {
      const jd = el("jdText").value;
      const results = summariseJD(jd, getCustomTerms());
      renderResults(results);
    }

    function showEmpty() {
      const e = document.getElementById('resultsEmpty');
      const s = document.getElementById('resultsSkeleton');
      if (e) e.classList.remove('hidden');
      if (s) s.classList.add('hidden');
    }

    function toggleLoading(isLoading) {
      const e = document.getElementById('resultsEmpty');
      const s = document.getElementById('resultsSkeleton');
      if (e) e.classList.add('hidden');
      if (!s) return;
      if (isLoading) s.classList.remove('hidden'); else s.classList.add('hidden');
      const analyse = document.getElementById('analyseBtn');
      const fetchB = document.getElementById('fetchBtn');
      if (analyse) analyse.disabled = !!isLoading;
      if (fetchB) fetchB.disabled = !!isLoading;
    }

    function updateCharCount() {
      const v = (el('jdText')?.value || '');
      const c = document.getElementById('jdChar');
      if (c) c.textContent = v.length + ' chars';
    }
    document.getElementById('jdText').addEventListener('input', updateCharCount);
    updateCharCount();
    showEmpty();

    // Back to top
    const btt = document.getElementById('backToTop');
    function onScroll(){ if (window.scrollY > 400) btt.classList.remove('hidden'); else btt.classList.add('hidden'); }
    window.addEventListener('scroll', onScroll, { passive: true });
    btt.addEventListener('click', () => { if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) window.scrollTo(0,0); else window.scrollTo({ top:0, behavior:'smooth' }); });

    el("analyseBtn").addEventListener("click", runAnalysis);

    // Keyboard shortcuts: Enter/Cmd+Enter summarise; Esc clear
    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().includes('MAC');
      if ((e.key === 'Enter' && (isMac ? e.metaKey : e.ctrlKey)) || (e.key === 'Enter' && e.target.id === 'jdText')) {
        e.preventDefault();
        runAnalysis();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        el('jdText').value = '';
        renderResults({ top10: [], countsByCategory: {}, customCounts: {}, meta: {} });
      }
    });

    el("clearBtn").addEventListener("click", () => {
      el("jdText").value = "";
      renderResults({ top10: [], countsByCategory: {}, customCounts: {}, meta: {} });
    });

    function buildProxyUrls(raw) {
      // Returns an array of proxy URLs to try
      try {
        const u = new URL(raw);
        const proto = (u.protocol || 'https:').replace(':',''); // 'http' | 'https'
        const path = u.pathname + (u.search || "") + (u.hash || "");
        const base = u.host + path;
        const urls = [
          `https://r.jina.ai/${proto}://${base}`,
          // Try the alternate protocol as well
          `https://r.jina.ai/${proto === 'https' ? 'http' : 'https'}://${base}`
        ];
        return urls;
      } catch (_) { return []; }
    }

    function setFetchStatus(message, kind) {
      const s = document.getElementById('fetchStatus');
      if (!s) return;
      const base = 'text-xs';
      const classes = {
        info: 'text-slate-600 dark:text-slate-300',
        success: 'text-emerald-700 dark:text-emerald-400',
        warn: 'text-amber-700 dark:text-amber-400',
        error: 'text-rose-700 dark:text-rose-400'
      };
      s.className = base + ' ' + (classes[kind] || classes.info);
      s.textContent = message || '';
    }

    el("fetchBtn").addEventListener("click", async () => {
      const raw = el("jdUrl").value.trim();
      if (!raw) return;
      // Default to proxy unless explicitly unticked
      const wantProxy = (document.getElementById('useProxy')?.checked !== false);
      let tryUrls = [];
      if (wantProxy) {
        tryUrls = tryUrls.concat(buildProxyUrls(raw));
      }
      tryUrls.push(raw); // always try direct as well (or vice versa)

      el("fetchBtn").disabled = true;
      el("fetchBtn").textContent = "Fetching…";
      el("fetchBtn").setAttribute('aria-busy','true');
      setFetchStatus('Fetching job description…', 'info');
      const spinner = document.getElementById('fetchSpinner');
      if (spinner) spinner.classList.remove('hidden');
      let lastErr = null;
      for (const u of tryUrls) {
        try {
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), 12000);
          const res = await fetch(u, {mode: "cors", signal: controller.signal});
          clearTimeout(timer);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();
          const text = htmlToText(html);
        el("jdText").value = text;
          lastErr = null;
          setFetchStatus('Loaded successfully. Analysing…', 'info');
          // Auto-run summarisation after successful fetch
          await Promise.resolve().then(runAnalysis);
          break;
      } catch (e) {
          lastErr = e;
          // Keep trying next URL
        }
      }
      if (lastErr) {
        const msg = (lastErr.name === 'AbortError') ? 'Timed out fetching the page.' : (lastErr && lastErr.message ? lastErr.message : 'Unknown error');
        setFetchStatus(`Fetch failed (likely CORS or blocked). ${msg}. Try enabling the proxy or copy-paste instead.`, 'error');
      }
        el("fetchBtn").disabled = false;
        el("fetchBtn").textContent = "Fetch";
      el("fetchBtn").removeAttribute('aria-busy');
      if (spinner) spinner.classList.add('hidden');
    });

    // File upload support (.txt / .html)
    document.addEventListener('change', async (e) => {
      const target = e.target;
      if (target && target.id === 'fileInput' && target.files && target.files[0]) {
        const file = target.files[0];
        const text = await file.text();
        const plain = file.type.includes('html') ? htmlToText(text) : text;
        el('jdText').value = plain;
      }
      if (target && target.id === 'cvFile' && target.files && target.files[0]) {
        const file = target.files[0];
        try {
          if (file.type === 'text/plain') {
            const t = await file.text();
            el('cvText').value = t;
          } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || /\.docx$/i.test(file.name)) {
            const arrayBuffer = await file.arrayBuffer();
            const res = await window.mammoth.extractRawText({arrayBuffer});
            el('cvText').value = (res && res.value ? res.value : '').replace(/\s+/g,' ').trim();
          } else if (file.type === 'application/pdf' || /\.pdf$/i.test(file.name)) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window['pdfjsLib'].getDocument({data: arrayBuffer}).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const content = await page.getTextContent();
              const strings = content.items.map(it => (it.str || ''));
              fullText += strings.join(' ') + '\n';
            }
            el('cvText').value = fullText.replace(/\s+/g,' ').trim();
          }
        } catch (err) {
          alert('Failed to read CV file. Please try a .txt export or paste text.\n\n' + (err && err.message ? err.message : ''));
        }
      }
    });

    // Manual match button
    document.getElementById('cvMatchBtn').addEventListener('click', () => {
      runAnalysis();
      announcer.textContent = 'JD and CV matched.';
    });

    // BEGIN Tailor CV wiring
    import('./src/main.js').then(({ fetchReadable, buildSuggestions, buildSuggestionsLLM, downloadDocx }) => {
      const srcRadios = document.getElementsByName('jobSrc');
      const tailorPaste = document.getElementById('tailorPaste');
      const tailorUrl = document.getElementById('tailorUrl');
      const statusEl = document.getElementById('tailorStatus');
      const suggPane = document.getElementById('suggPane');
      const diffPane = document.getElementById('diffPane');
      let lastSuggestions = null;
      let templateFile = null;
      let lastLLMText = '';

      function setStatus(msg, kind='info') {
        const map = { info: 'text-slate-600', success: 'text-emerald-700', error: 'text-rose-700' };
        statusEl.className = 'text-xs mt-2 ' + (map[kind]||map.info);
        statusEl.textContent = msg || '';
      }

      srcRadios.forEach(r => r.addEventListener('change', () => {
        const v = Array.from(srcRadios).find(x => x.checked)?.value;
        if (v === 'url') { tailorUrl.classList.remove('hidden'); tailorPaste.classList.add('hidden'); }
        else { tailorUrl.classList.add('hidden'); tailorPaste.classList.remove('hidden'); }
      }));

      document.getElementById('templateDocx').addEventListener('change', (e) => {
        templateFile = e.target.files && e.target.files[0] ? e.target.files[0] : null;
      });

      document.getElementById('genSuggBtn').addEventListener('click', async () => {
        try {
          setStatus('Generating suggestions…');
          let jdText = '';
          const src = Array.from(srcRadios).find(x => x.checked)?.value;
          if (src === 'url') {
            const u = document.getElementById('tailorJdUrl').value.trim();
            if (!u) { setStatus('Please enter a job URL.', 'error'); return; }
            jdText = await fetchReadable(u);
          } else {
            jdText = document.getElementById('tailorJdText').value;
            if (!jdText.trim()) { setStatus('Please paste the job description.', 'error'); return; }
          }
          const skills = (document.getElementById('targetSkills').value||'').split(',').map(s=>s.trim()).filter(Boolean);
          if (window.PROXY_URL) {
            try {
              const llm = await buildSuggestionsLLM(window.PROXY_URL.replace(/\/$/, '') + '/api/suggest', jdText, skills, { roles: [] });
              lastLLMText = llm.llmText || '';
            } catch (_) { lastLLMText = ''; }
          } else {
            lastLLMText = '';
          }
          lastSuggestions = buildSuggestions(jdText, skills, { roles: [] });
          if (lastLLMText) mergeLLMTextIntoSuggestions(lastSuggestions, lastLLMText);
          renderSuggestions(lastSuggestions);
          setStatus('Suggestions ready.', 'success');
        } catch (e) {
          setStatus(e.message || 'Failed to fetch or generate.', 'error');
        }
      });

      document.getElementById('downloadDocxBtn').addEventListener('click', async () => {
        if (!lastSuggestions) { setStatus('Generate suggestions first.', 'error'); return; }
        await downloadDocx({ suggestions: lastSuggestions, templateFile, filename: 'Abdalbast_Khdhir_CV_Tailored.docx' });
      });

      function renderSuggestions(s) {
        suggPane.innerHTML = '';
        if (lastLLMText) {
          const llmDiv = document.createElement('div');
          llmDiv.className = 'p-3 border dark:border-slate-700 rounded bg-indigo-50 dark:bg-indigo-200/10 text-indigo-800 dark:text-indigo-200';
          llmDiv.innerHTML = `<div class=\"font-medium mb-1\">LLM refinement</div><pre class=\"whitespace-pre-wrap text-sm\">${lastLLMText.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}</pre>`;
          suggPane.appendChild(llmDiv);
        }
        const sections = [
          ['Profile', s.profile||[]],
          ['Key Skills', (s.keySkills||[]).map(k=>`• ${k}`)],
          ['Experience', (s.experience||[]).flatMap(e=>[`— ${e.role}`].concat((e.bullets||[]).map(b=>`• ${b}`)))],
          ['Education', s.education||[]],
          ['Additional', s.additional||[]],
        ];
        sections.forEach(([title, items]) => {
          const div = document.createElement('div');
          div.innerHTML = `<h3 class="font-medium mb-1">${title}</h3>` +
            `<ul class="list-disc pl-5 space-y-1">${items.map(i=>`<li>${i}</li>`).join('')}</ul>`;
          suggPane.appendChild(div);
        });
        // Diff stub
        diffPane.innerHTML = `<details><summary class="cursor-pointer">Profile</summary><div class="mt-2">${(s.profile||[]).join(' ')}</div></details>`;
      }

      document.getElementById('tabSugg').addEventListener('click', () => { suggPane.classList.remove('hidden'); diffPane.classList.add('hidden'); });
      document.getElementById('tabDiff').addEventListener('click', () => { diffPane.classList.remove('hidden'); suggPane.classList.add('hidden'); });

      // ARIA tabs keyboard support
      const tabs = [document.getElementById('tabSugg'), document.getElementById('tabDiff')];
      function activateTab(i){
        tabs.forEach((t,idx)=>{ t.setAttribute('aria-selected', String(idx===i)); t.tabIndex = idx===i?0:-1; });
        if (i===0){ suggPane.classList.remove('hidden'); diffPane.classList.add('hidden'); }
        else { diffPane.classList.remove('hidden'); suggPane.classList.add('hidden'); }
        tabs[i].focus();
      }
      tabs.forEach((t,idx)=> t.addEventListener('keydown', (e)=>{
        if (e.key==='ArrowRight' || e.key==='ArrowLeft') {
          e.preventDefault();
          const ni = (idx + (e.key==='ArrowRight'?1:-1) + tabs.length) % tabs.length;
          activateTab(ni);
        }
      }));

      // Copy buttons
      document.getElementById('copySuggJson').addEventListener('click', async ()=>{
        try { await navigator.clipboard.writeText(JSON.stringify(lastSuggestions||{}, null, 2)); } catch {}
      });
      document.getElementById('copyLLM').addEventListener('click', async ()=>{
        try { await navigator.clipboard.writeText(lastLLMText||''); } catch {}
      });

      function mergeLLMTextIntoSuggestions(s, text) {
        const lines = (text||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        if (!lines.length) return s;
        // Extract up to two non-bullet lines for profile
        const nonBullets = lines.filter(l => !/^[-•]/.test(l)).slice(0,2);
        s.profile = Array.from(new Set([...(s.profile||[]), ...nonBullets])).slice(0,2);
        // Bullet-like lines → experience bullets on first role
        const bullets = lines.filter(l => /^[-•]/.test(l)).map(l => l.replace(/^[-•]\s?/, ''));
        if (!s.experience || !s.experience.length) s.experience = [{ role: 'Recent Experience', bullets: [] }];
        s.experience[0].bullets = Array.from(new Set([...(s.experience[0].bullets||[]), ...bullets])).slice(0,8);
        // Try to harvest capitalised words as potential skills
        const maybeSkills = lines.flatMap(l => (l.match(/\b([A-Z][A-Za-z0-9+.#-]{1,}\b)/g) || []));
        s.keySkills = Array.from(new Set([...(s.keySkills||[]), ...maybeSkills])).slice(0,12);
        return s;
      }
    });
    // END Tailor CV wiring
  </script>
</body>
</html>
